<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculator</title>
  <style>
    :root{
      --bg:#0f1724;
      --panel:#111827;
      --accent:#10b981;
      --muted:#94a3b8;
      --btn:#1f2937;
      --btn-hover:#374151;
      --text:#e6eef8;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,var(--bg),#071024 140%);
      color:var(--text);
      padding:24px;
    }
    .calc {
      width:340px;
      background:linear-gradient(180deg,var(--panel),#0b1220);
      border-radius:14px;
      padding:18px;
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
    }
    .display {
      height:78px;
      background:transparent;
      border-radius:8px;
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:flex-end;
      gap:6px;
      overflow:hidden;
    }
    .history {
      font-size:13px;
      color:var(--muted);
      width:100%;
      text-align:right;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    .output {
      font-size:28px;
      font-weight:600;
      letter-spacing:0.4px;
      width:100%;
      text-align:right;
      word-break:break-all;
    }
    .keys {
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    button {
      height:56px;
      border-radius:10px;
      border:0;
      background:var(--btn);
      color:var(--text);
      font-size:18px;
      cursor:pointer;
      transition:all .12s ease;
      box-shadow:0 2px 0 rgba(2,6,23,0.4);
    }
    button:hover{ transform:translateY(-2px); background:var(--btn-hover); }
    .span-2{ grid-column:span 2; }
    .op{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); }
    .accent{ background:linear-gradient(90deg,var(--accent),#06b6a4); color:#032; font-weight:700; box-shadow:0 6px 18px rgba(16,185,129,0.12); }
    .clear { background:#7c3aed; }
    @media (max-width:380px){
      .calc{ width:92vw; padding:14px; }
      .output{ font-size:24px; }
    }
  </style>
</head>
<body>
  <div class="calc" role="application" aria-label="Calculator">
    <div class="display" aria-live="polite">
      <div class="history" id="history"></div>
      <div class="output" id="display">0</div>
    </div>

    <div class="keys" id="keys">
      <button class="op" data-action="clear">C</button>
      <button class="op" data-action="plusminus">±</button>
      <button class="op" data-action="percent">%</button>
      <button class="op" data-value="/" title="divide">÷</button>

      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button class="op" data-value="*" title="multiply">×</button>

      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button class="op" data-value="-" title="minus">−</button>

      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button class="op" data-value="+" title="plus">+</button>

      <button class="span-2" data-value="0">0</button>
      <button data-value=".">.</button>
      <button class="accent" data-action="equals">=</button>

      <button class="span-2 op" data-value="(">(</button>
      <button class="op" data-value=")">)</button>
      <button class="op" data-action="backspace">⌫</button>
    </div>
  </div>

  <script>
    (function(){
      const displayEl = document.getElementById('display');
      const historyEl = document.getElementById('history');
      const keys = document.getElementById('keys');

      let expr = '';     // current expression string
      let lastEval = ''; // last evaluated result

      function updateDisplay(){
        displayEl.textContent = expr === '' ? '0' : expr;
      }

      // sanitize expression before eval: only digits, operators, parentheses, decimal, spaces
      function isSafeExpression(s){
        return /^[0-9+\-*/().%\s]+$/.test(s);
      }

      function safeEval(s){
        // Replace unicode × and ÷ if present
        s = s.replace(/×/g,'*').replace(/÷/g,'/');

        // Replace percent occurrences: e.g. "50%" -> "(50/100)"
        // We'll transform every number followed by % to "(number/100)"
        s = s.replace(/(\d+(\.\d+)?)%/g, '($1/100)');

        // final safety check
        if(!isSafeExpression(s)) throw new Error('Unsafe expression');

        // Evaluate with Function (safer than global eval since eval scope is local)
        // Still be careful: we validated characters above.
        // Use Number() to avoid accidental object returns.
        // We also limit length to avoid abuse.
        if(s.length > 200) throw new Error('Expression too long');

        // Evaluate
        const result = Function('"use strict"; return (' + s + ')')();
        if (result === Infinity || result === -Infinity || Number.isNaN(result)) throw new Error('Math error');
        // Trim floating rounding artifacts
        return (Math.round((result + Number.EPSILON) * 1e12) / 1e12).toString();
      }

      function insert(char){
        // prevent two operators in a row (except minus for negative numbers)
        const last = expr.slice(-1);
        const operators = '+-*/';
        if(operators.includes(char)){
          if(expr === '' && char !== '-') return; // don't start with +*/ only -
          if(operators.includes(last) && !(char === '-' && last !== '-')) {
            // replace last operator with new one
            expr = expr.slice(0, -1) + char;
            updateDisplay(); return;
          }
        }

        // Avoid multiple decimals in the current number
        if(char === '.'){
          // find last operator index
          const idx = Math.max(expr.lastIndexOf('+'), expr.lastIndexOf('-'), expr.lastIndexOf('*'), expr.lastIndexOf('/'));
          const current = expr.slice(idx + 1);
          if(current.includes('.')) return;
          if(current === '') char = '0.';
        }

        expr += char;
        updateDisplay();
      }

      function clearAll(){
        expr = '';
        lastEval = '';
        historyEl.textContent = '';
        updateDisplay();
      }

      function backspace(){
        expr = expr.slice(0, -1);
        updateDisplay();
      }

      function toggleSign(){
        // toggle sign of the last number token
        // find last operator
        const idx = Math.max(expr.lastIndexOf('+'), expr.lastIndexOf('-'), expr.lastIndexOf('*'), expr.lastIndexOf('/'));
        let before = expr.slice(0, idx + 1);
        let lastNum = expr.slice(idx + 1);
        if(lastNum === '') return;
        if(lastNum.startsWith('(-') && lastNum.endsWith(')')){
          // already wrapped as negative: unwrap
          lastNum = lastNum.slice(2, -1);
        } else {
          // wrap negative: but if there is an existing minus directly before, handle carefully
          lastNum = '(-' + lastNum + ')';
        }
        expr = before + lastNum;
        updateDisplay();
      }

      function applyPercent(){
        // convert last number to number/100
        const idx = Math.max(expr.lastIndexOf('+'), expr.lastIndexOf('-'), expr.lastIndexOf('*'), expr.lastIndexOf('/'));
        let before = expr.slice(0, idx + 1);
        let lastNum = expr.slice(idx + 1);
        if(lastNum === '') return;
        // If lastNum already contains parentheses or percent-like text, try safe replacement
        // We'll just append /100 if it looks numeric, otherwise ignore
        if(/^\(?-?\d+(\.\d+)?\)?$/.test(lastNum)){
          // remove wrapping parentheses if present
          lastNum = lastNum.replace(/^\(|\)$/g, '');
          expr = before + '(' + lastNum + '/100)';
          updateDisplay();
        }
      }

      function evaluate(){
        if(expr === '') return;
        try {
          const result = safeEval(expr);
          historyEl.textContent = expr + ' =';
          displayEl.textContent = result;
          lastEval = result;
          expr = result; // allow continued calculations
        } catch (err){
          displayEl.textContent = 'Error';
          setTimeout(() => updateDisplay(), 900);
        }
      }

      keys.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const val = btn.getAttribute('data-value');
        const action = btn.getAttribute('data-action');

        if(action === 'clear') { clearAll(); return; }
        if(action === 'backspace') { backspace(); return; }
        if(action === 'plusminus') { toggleSign(); return; }
        if(action === 'percent') { applyPercent(); return; }
        if(action === 'equals') { evaluate(); return; }
        if(val) {
          // convert union chars
          if(val === '÷') insert('/');
          else if(val === '×') insert('*');
          else insert(val);
        }
      });

      // keyboard support
      window.addEventListener('keydown', (e) => {
        const key = e.key;
        if((/^[0-9]$/).test(key)) { insert(key); e.preventDefault(); return; }
        if(key === '.' ) { insert('.'); e.preventDefault(); return; }
        if(key === 'Enter' || key === '='){ evaluate(); e.preventDefault(); return; }
        if(key === 'Backspace'){ backspace(); e.preventDefault(); return; }
        if(key === 'Escape'){ clearAll(); e.preventDefault(); return; }
        if(key === '+'){ insert('+'); e.preventDefault(); return; }
        if(key === '-') { insert('-'); e.preventDefault(); return; }
        if(key === '*' || key === 'x' || key === 'X'){ insert('*'); e.preventDefault(); return; }
        if(key === '/') { insert('/'); e.preventDefault(); return; }
        if(key === '%'){ applyPercent(); e.preventDefault(); return; }
        if(key === '(' || key === ')'){ insert(key); e.preventDefault(); return; }
      });

      // initialize
      updateDisplay();
    })();
  </script>
</body>
</html>